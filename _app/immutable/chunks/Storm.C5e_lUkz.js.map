{"version":3,"file":"Storm.C5e_lUkz.js","sources":["../../../../../../src/lib/components/Storm.svelte"],"sourcesContent":["<script lang=\"ts\">\n    import { onMount } from \"svelte\"\n    import { base } from \"$app/paths\"\n    // import * as Three from 'three'\n\n    // let clock = new Three.Clock()\n\n    // CSS Rain Effect\n    // https://codepen.io/REast/pen/ExZeWP\n    // Canvas Bubbles\n    // https://codepen.io/MarioD/pen/gWregQ\n    // Animating with requestAnimationFrame\n    // https://joshondesign.com/p/books/canvasdeepdive/chapter04.html\n    // Optimizing canvas\n    // https://developer.mozilla.org/en-US/docs/Web/API/Canvas_API/Tutorial/Optimizing_canvas\n    // TODO\n\n    let { class: className = '' } = $props()\n\n    let rainContainer: HTMLDivElement\n    let ctx: CanvasRenderingContext2D,\n        canvasWidth: number,\n        canvasHeight: number,\n        canvasFill: string,\n        msTimer = 0.0,\n        lightningTimer = $state(8000),\n        lightningAlpha = 0,\n        rainArr: { x: number, y: number, z: number, w?: number }[] = [],\n        rainSpeed = 0.5,\n        rainCount = 300,\n        gameLoop: number,\n        weatherEnabled = $state(false),\n        dialouge = $state(\"\"),\n        dialougeLoop: number,\n        sonettoSpeaksFrameRequest = $state(0)\n\n    function updateCanvasPosition(canvas: HTMLCanvasElement, container: HTMLDivElement) {\n        const containerWidth = container.clientWidth\n        const containerHeight = container.clientHeight\n        if (canvas) {\n            canvasWidth = canvas.width = Math.max(500, containerWidth)\n            canvasHeight = canvas.height = Math.max(320, containerHeight)\n        }\n        container.style.left = container.style.right = container.style.top = container.style.bottom = \"0\";\n    }\n\n    function createRain() {\n        rainArr = []\n        for (let i = rainCount - 1; i >= 0; i--) {\n            rainArr.push({\n                x: Math.floor((Math.random() * document.documentElement.clientWidth) + 9),\n                y: 0,\n                z: 0\n            })\n        }\n\n        for (let j = 0; j < rainCount; j++) {\n            rainArr[j].x = Math.floor((Math.random() * document.documentElement.clientWidth) + 9)\n            rainArr[j].y = Math.floor((Math.random() * rainContainer.clientHeight) + 9)\n            rainArr[j].z = Math.floor((Math.random() * 2) + 1)\n            rainArr[j].w = Math.floor((Math.random() * 3) + 2)\n        }\n    }\n\n    /**\n     * Paints and updates the raindrops position on the canvas\n     */\n    function paintRain() {\n        for (let i = 0; i < rainCount; i++) {\n            // use this for resetting falling rain\n            // if (rainArr[i].y >= rainContainer.clientHeight) {\n            //     rainArr[i].y -= rainContainer.clientHeight\n            // }\n\n            // reset rain y position when reaching the top\n            if (rainArr[i].y <= 0) {\n                rainArr[i].y += rainContainer.clientHeight\n            }\n            if (rainArr[i].x < -10) {\n                rainArr[i].x += canvasWidth\n            } else {\n                // use += if we want rain to fall down instead\n                rainArr[i].y -= Number(rainArr[i]?.w ?? 1) * rainSpeed\n                // this one adds a slight angle to rain drops\n                // rainArr[i].x -= 5 + Math.floor(rainArr[i].y / 250) - Number(rainArr[i]?.w ?? 0)\n            }\n\n            const gradient = ctx.createRadialGradient(250, 450, 140, 250, 300, 600)\n            if (localStorage.getItem('ots:theme') === 'dark') {\n                gradient.addColorStop(0, 'rgba(100, 170, 160, 0.2)')\n                gradient.addColorStop(0.1, 'rgba(100, 160, 160, 0.12)')\n                gradient.addColorStop(0.2, 'rgba(100, 150, 150, 0.1)')\n                gradient.addColorStop(1, 'rgba(100, 140, 140, .08)')\n            } else {\n                gradient.addColorStop(0, 'rgba(0, 0, 0, 0.2)')\n            }\n            ctx.fillStyle = gradient\n            ctx.fillRect(rainArr[i].x, rainArr[i].y, rainArr[i].z, 4)\n        }\n    }\n\n    /**\n     * Add lightning effect\n     */\n    function simulateWeather(timer: number) {\n        if (weatherEnabled) {\n            lightningAlpha = 0\n            if (timer > 350) {\n                lightningAlpha = (500 - timer) * 0.004\n            } else if (timer < 350 && timer > 250) {\n                lightningAlpha = (timer - 250) * 0.006\n            } else if (timer < 250 && timer >= 100) {\n                lightningAlpha = (250 - timer) * 0.004\n            } else if (timer < 100 && timer >= 0) {\n                lightningAlpha = timer * 0.006\n                // Reset everything to default\n                weatherEnabled = false // disable lightning\n                lightningTimer = 8000 // reset lightning timer\n            }\n\n            if (lightningAlpha > 0) {\n                ctx.fillStyle = localStorage.getItem('ots:theme') === 'dark'\n                    ? `rgba(250, 250, 245, ${lightningAlpha})`\n                    : `rgba(0, 0, 0, ${lightningAlpha})`\n                ctx.fillRect(0, 0, canvasWidth, canvasHeight)\n            }\n        }\n    }\n\n    function mainLoop() {\n        // const elapsedTime = clock.getElapsedTime()\n\n        const canvas = document.querySelector('canvas')\n        if (canvas) {\n            updateCanvasPosition(canvas, rainContainer)\n        }\n        // msTimer += 30 // this is used for the lamp post\n        if (weatherEnabled) {\n            if (lightningTimer < 0) {\n                lightningTimer = 8000\n            } else {\n                lightningTimer -= 15 // previously using 30 when using setInterval\n            }\n        }\n\n        // ctx.fillStyle = \"#202426\"\n        canvasFill = localStorage.getItem('ots:theme') === 'dark' ? \"#0f172a\" : \"#ffffff\"\n        ctx.fillStyle = canvasFill\n        ctx.fillRect(0, 0, canvasWidth, canvasHeight)\n\n        paintRain()\n\n        if (lightningTimer < 500) {\n            // console.log(Number(elapsedTime.toFixed(0)))\n            simulateWeather(lightningTimer)\n        }\n\n        window.requestAnimationFrame(mainLoop)\n    }\n\n    function momentWithSonetto(event: MouseEvent & { currentTarget: EventTarget & HTMLButtonElement }) {\n        weatherEnabled = true\n        const phrases = [\n            \"Timekeeper\",\n            \"It's raining outside.\",\n            \"and the raindrops...\",\n            \"*Gasp*\",\n            \"Eeeek!\"\n        ]\n        const typeSpeed = 1\n        // let charIndex = 0\n        // let counter = 0\n        function within(timer: number, rangeStart: number, rangeEnd: number) {\n            return timer <= rangeStart && timer >= rangeEnd\n        }\n        function typeWriter(phrase: string) {\n            const start = performance.now()\n            const duration = (phrase.length * 60) / typeSpeed\n            function tick() {\n                const id = window.requestAnimationFrame(tick)\n                const now = performance.now()\n                const i = Math.trunc((phrase.length * (now - start)) / duration)\n                if (dialouge !== phrase) {\n                    dialouge = phrase.slice(0, i)\n                } else {\n                    window.cancelAnimationFrame(id)\n                }\n            }\n            tick()\n        }\n        function sonnettoSpeaks() {\n            sonettoSpeaksFrameRequest = window.requestAnimationFrame(sonnettoSpeaks)\n            if (weatherEnabled) {\n                if (within(lightningTimer, 8000, 6000)) {\n                    typeWriter(phrases[0])\n                }\n                if (within(lightningTimer, 6000, 4000)) {\n                    typeWriter(phrases[1])\n                }\n                if (within(lightningTimer, 4000, 2000)) {\n                    typeWriter(phrases[2])\n                }\n                if (within(lightningTimer, 2000, 500)) {\n                    typeWriter(phrases[3])\n                }\n                if (within(lightningTimer, 500, 0)) {\n                    typeWriter(phrases[4])\n                }\n            } else {\n                cancelAnimationFrame(sonettoSpeaksFrameRequest)\n                setTimeout((target: HTMLButtonElement) => {\n                    dialouge = \"\"\n                    target.blur()\n                }, 2000, event.target)\n            }\n        }\n        sonnettoSpeaks()\n        // dialougeLoop = setInterval(() => {\n        //     dialouge = phrases[counter]\n        //     counter++\n        //     if (!weatherEnabled) {\n        //         setTimeout((target: HTMLButtonElement) => {\n        //             dialouge = \"\"\n        //             target.blur()\n        //             clearInterval(dialougeLoop)\n        //         }, 2000, event.target)\n        //     }\n        // }, 2000)\n    }\n    \n    onMount(() => {\n        // const backgroundMusic = new Audio('/audio/reverse-bgm.mp3')\n        // backgroundMusic.loop = true\n        // backgroundMusic.addEventListener('canplaythrough', () => {\n        //     backgroundMusic.play()\n        // })\n        const div = document.createElement('div')\n        const canvas = document.createElement('canvas')\n        canvasFill = localStorage.getItem('ots:theme') === 'dark' ? \"#0f172a\" : \"#ffffff\"\n        const resizeObserver = new ResizeObserver((entries) => {\n            rainArr = []\n            createRain()\n        })\n        resizeObserver.observe(rainContainer)\n        ctx = canvas.getContext('2d', { alpha: false }) as CanvasRenderingContext2D\n\n        rainContainer.appendChild(div)\n        div.style.position = 'fixed'\n        div.appendChild(canvas)\n        updateCanvasPosition(canvas, rainContainer)\n        createRain()\n\n        // 1 frame every 30ms\n        // if (typeof gameLoop !== undefined) {\n        //     clearInterval(gameLoop)\n        //     gameLoop = setInterval(mainLoop, 30)\n        // }\n        mainLoop()\n    })\n</script>\n\n<div bind:this={rainContainer} class=\"rain-container fixed inset-0 -z-10 pointer-events-none {className}\"></div>\n\n<div class=\"fixed top-6 z-10 right-10 md:right-20 flex items-center gap-2 {className}\">\n    <span class=\"dialouge crimson-text-regular text-sm\">{ dialouge }</span>\n    <button onclick={momentWithSonetto} disabled={weatherEnabled} type=\"button\" class=\"outline-none hover:opacity-100 focus:opacity-100 transition-opacity\" class:opacity-20={!weatherEnabled}>\n        <img src=\"{base}/img/character/sonetto.webp\" alt=\"Vertin\" class=\"w-10 h-10 rounded-full overflow-hidden pointer-events-none\">\n    </button>\n</div>\n"],"names":["momentWithSonetto","event","$.set","weatherEnabled","phrases","typeSpeed","within","timer","rangeStart","rangeEnd","typeWriter","phrase","start","duration","tick","id","now","i","dialouge","sonnettoSpeaks","sonettoSpeaksFrameRequest","$.proxy","$.get","lightningTimer","target","className","$.prop","$$props","rainContainer","ctx","canvasWidth","canvasHeight","canvasFill","$.source","lightningAlpha","rainArr","rainSpeed","rainCount","updateCanvasPosition","canvas","container","containerWidth","containerHeight","createRain","j","paintRain","_a","gradient","simulateWeather","mainLoop","onMount","div","entries","$.bind_this","div_1","$$value","base"],"mappings":"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"}